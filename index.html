<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–≥–æ–¥–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ - –í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 400px;
            background: white;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            transition: all 0.3s ease;
            position: relative;
        }
        .sidebar.collapsed {
            width: 50px;
            padding: 15px 5px;
        }
        .sidebar.collapsed .sidebar-content {
            display: none;
        }
        .map-container {
            flex: 1;
            position: relative;
            transition: all 0.3s ease;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .filters {
            margin-bottom: 15px;
        }
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 10px;
            border: 1px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            background: white;
            color: #007bff;
        }
        .filter-btn.active {
            background: #007bff;
            color: white;
        }
        .municipality-list {
            margin-top: 10px;
        }
        .municipality-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }
        .municipality-item:hover {
            background: #f8f9fa;
        }
        .municipality-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }
        .municipality-info {
            color: #666;
            font-size: 11px;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 12px;
            border: 1px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            background: white;
            color: #007bff;
        }
        .btn:hover {
            background: #007bff;
            color: white;
        }
        .btn-update {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .btn-update:hover {
            background: #218838;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
        .toggle-sidebar {
            position: absolute;
            top: 10px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .toggle-sidebar:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }
        .sidebar.collapsed .toggle-sidebar {
            right: -15px;
            transform: rotate(180deg);
        }
        .sidebar.collapsed .toggle-sidebar:hover {
            transform: rotate(180deg) scale(1.1);
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ü–∏—é –∫–∞—Ä—Ç—ã */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç–æ–∫ */
        .municipality-dot {
            background: #007bff;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .vologda-dot {
            background: #dc3545;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .cherepovets-dot {
            background: #28a745;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –±—Ä–∏–≥–∞–¥—ã */
        .brigade-icon {
            background: #ff6b00;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .brigade-icon:hover {
            transform: scale(1.3);
            z-index: 1000;
        }

        /* –õ–µ–≥–µ–Ω–¥–∞ –∫–∞—Ä—Ç—ã */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ */
        .risk-controls {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .risk-controls h3 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        .scenario-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .scenario-btn {
            padding: 8px 12px;
            border: 1px solid #6c757d;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            background: white;
            color: #495057;
            text-align: left;
            transition: all 0.2s ease;
        }
        .scenario-btn:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .scenario-btn:nth-child(2):hover { /* –û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è */
            border-color: #28a745;
            color: #28a745;
        }

        .scenario-btn:nth-child(3):hover { /* –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ */
            border-color: #ffc107;
            color: #ffc107;
        }

        .scenario-btn:nth-child(4):hover { /* –ü–ª–æ—Ö–∏–µ */
            border-color: #fd7e14;
            color: #fd7e14;
        }

        .scenario-btn:nth-child(5):hover { /* –û–ø–∞—Å–Ω—ã–µ */
            border-color: #dc3545;
            color: #dc3545;
        }

        .scenario-btn:nth-child(6):hover { /* –ì—Ä–∞–¥–∏–µ–Ω—Ç */
            border-color: #6f42c1;
            color: #6f42c1;
        }

        .risk-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .risk-low { background-color: #28a745; }
        .risk-medium { background-color: #ffc107; }
        .risk-high { background-color: #fd7e14; }
        .risk-critical { background-color: #dc3545; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ø–∞–ø–æ–≤ */
        .risk-popup {
            min-width: 280px;
        }
        .risk-level {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .risk-details {
            font-size: 12px;
        }
        .risk-factor {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        .api-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }
        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Å–≤–µ—Ä–Ω—É—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
        .collapsed-icons {
            display: none;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .sidebar.collapsed .collapsed-icons {
            display: flex;
        }
        .icon-btn {
            width: 35px;
            height: 35px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .icon-btn:hover {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }
        .icon-tooltip {
            position: absolute;
            left: 45px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1001;
        }
        .icon-btn:hover .icon-tooltip {
            opacity: 1;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π */
        .damage-stats {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ddd;
            font-size: 11px;
        }
        .damage-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .damage-count {
            font-weight: bold;
        }
        .damage-high {
            color: #dc3545;
        }
        .damage-medium {
            color: #fd7e14;
        }
        .damage-low {
            color: #28a745;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±—Ä–∏–≥–∞–¥ */
        .brigade-icon-2 {
            background: #17a2b8;
            border: 3px solid white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }
        .brigade-icon-3 {
            background: #6f42c1;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: white;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="toggle-sidebar" onclick="toggleSidebar()">‚Äπ</div>

            <div class="sidebar-content">
                <h1>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–≥–æ–¥–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤</h1>

                <div class="search-box">
                    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞..." id="searchInput">
                </div>

                <div class="filters">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterMunicipalities('all')">–í—Å–µ</button>
                        <button class="filter-btn" onclick="filterMunicipalities('city')">–ì–æ—Ä–æ–¥–∞</button>
                        <button class="filter-btn" onclick="filterMunicipalities('municipality')">–†–∞–π–æ–Ω—ã</button>
                    </div>
                </div>

                <div class="risk-controls">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:</h3>
                    <div class="scenario-buttons">
                        <button class="scenario-btn" onclick="updateWeatherData()">
                            <span class="loading" id="loadingIndicator" style="display: none;"></span>
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="scenario-btn" onclick="applyWeatherScenario('excellent')">‚úÖ –û—Ç–ª–∏—á–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</button>
                        <button class="scenario-btn" onclick="applyWeatherScenario('satisfactory')">üü° –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</button>
                        <button class="scenario-btn" onclick="applyWeatherScenario('poor')">üü† –ü–ª–æ—Ö–∏–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</button>
                        <button class="scenario-btn" onclick="applyWeatherScenario('dangerous')">üî¥ –û–ø–∞—Å–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</button>
                        <button class="scenario-btn" onclick="applyWeatherScenario('gradient')">üåà –í—Å–µ —Ç–∏–ø—ã –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π</button>
                    </div>
                </div>

                <div id="apiStatus" class="api-status status-offline">
                    ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                </div>

                <div class="controls">
                    <button class="btn" onclick="showAllMunicipalities()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn" onclick="resetMap()">–°–±—Ä–æ—Å</button>
                    <button class="btn" onclick="highlightRegion()">–û–±–≤–µ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç—å</button>
                    <button class="btn" onclick="toggleRiskOverlay()" id="toggleRiskOverlayBtn">–°–∫—Ä—ã—Ç—å —Ü–≤–µ—Ç–Ω—É—é –∫–∞—Ä—Ç—É —Ä–∏—Å–∫–æ–≤</button>
                    <button class="btn" onclick="toggleBrigades()" id="toggleBrigadesBtn">–°–∫—Ä—ã—Ç—å –±—Ä–∏–≥–∞–¥—ã</button>
                </div>

                <div class="municipality-list" id="municipalityList">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div class="loading"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                    </div>
                </div>
            </div>

            <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Å–≤–µ—Ä–Ω—É—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
            <div class="collapsed-icons">
                <button class="icon-btn" onclick="updateWeatherData()" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                    üîÑ
                    <div class="icon-tooltip">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                </button>
                <button class="icon-btn" onclick="applyWeatherScenario('excellent')" title="–û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è">
                    ‚úÖ
                    <div class="icon-tooltip">–û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</div>
                </button>
                <button class="icon-btn" onclick="applyWeatherScenario('satisfactory')" title="–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ">
                    üü°
                    <div class="icon-tooltip">–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ</div>
                </button>
                <button class="icon-btn" onclick="applyWeatherScenario('poor')" title="–ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è">
                    üü†
                    <div class="icon-tooltip">–ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è</div>
                </button>
                <button class="icon-btn" onclick="applyWeatherScenario('dangerous')" title="–û–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è">
                    üî¥
                    <div class="icon-tooltip">–û–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</div>
                </button>
                <button class="icon-btn" onclick="applyWeatherScenario('gradient')" title="–í—Å–µ —Ç–∏–ø—ã —É—Å–ª–æ–≤–∏–π">
                    üåà
                    <div class="icon-tooltip">–í—Å–µ —Ç–∏–ø—ã —É—Å–ª–æ–≤–∏–π</div>
                </button>
                <button class="icon-btn" onclick="showAllMunicipalities()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ">
                    üìç
                    <div class="icon-tooltip">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</div>
                </button>
                <button class="icon-btn" onclick="resetMap()" title="–°–±—Ä–æ—Å">
                    üè†
                    <div class="icon-tooltip">–°–±—Ä–æ—Å</div>
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <div class="legend-title">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –¥–ª—è –õ–≠–ü</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28a745;"></div>
                    <span>–ù–∏–∑–∫–∏–π (0-3)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffc107;"></div>
                    <span>–°—Ä–µ–¥–Ω–∏–π (4-6)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #fd7e14;"></div>
                    <span>–í—ã—Å–æ–∫–∏–π (7-8)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc3545;"></div>
                    <span>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (9-10)</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –î–∞–Ω–Ω—ã–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
        const municipalities = [
            // –ì–æ—Ä–æ–¥—Å–∫–∏–µ –æ–∫—Ä—É–≥–∞
            {name: "–í–æ–ª–æ–≥–¥–∞", coords: [59.2181, 39.8886], type: "city", population: "317822", center: "–≥. –í–æ–ª–æ–≥–¥–∞"},
            {name: "–ß–µ—Ä–µ–ø–æ–≤–µ—Ü", coords: [59.1266, 37.9093], type: "city", population: "298160", center: "–≥. –ß–µ—Ä–µ–ø–æ–≤–µ—Ü"},

            // –ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –∏ —Ä–∞–π–æ–Ω—ã
            {name: "–ë–∞–±–∞–µ–≤—Å–∫–∏–π", coords: [59.3833, 35.9500], type: "municipality", population: "18541", center: "–≥. –ë–∞–±–∞–µ–≤–æ"},
            {name: "–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∏–π", coords: [59.7500, 43.1167], type: "municipality", population: "9307", center: "—Å. –∏–º. –ë–∞–±—É—à–∫–∏–Ω–∞"},
            {name: "–ë–µ–ª–æ–∑–µ—Ä—Å–∫–∏–π", coords: [60.0333, 37.7833], type: "municipality", population: "12978", center: "–≥. –ë–µ–ª–æ–∑–µ—Ä—Å–∫"},
            {name: "–í–∞—à–∫–∏–Ω—Å–∫–∏–π", coords: [60.3667, 37.9333], type: "municipality", population: "5872", center: "—Å. –õ–∏–ø–∏–Ω –ë–æ—Ä"},
            {name: "–í–µ–ª–∏–∫–æ—É—Å—Ç—é–≥—Å–∫–∏–π", coords: [60.7585, 46.3044], type: "municipality", population: "48563", center: "–≥. –í–µ–ª–∏–∫–∏–π –£—Å—Ç—é–≥"},
            {name: "–í–µ—Ä—Ö–æ–≤–∞–∂—Å–∫–∏–π", coords: [60.7167, 41.9833], type: "municipality", population: "12287", center: "—Å. –í–µ—Ä—Ö–æ–≤–∞–∂—å–µ"},
            {name: "–í–æ–∂–µ–≥–æ–¥—Å–∫–∏–π", coords: [60.4667, 40.2167], type: "municipality", population: "13416", center: "–ø. –í–æ–∂–µ–≥–∞"},
            {name: "–í–æ–ª–æ–≥–æ–¥—Å–∫–∏–π", coords: [59.3000, 39.9000], type: "municipality", population: "51950", center: "–≥. –í–æ–ª–æ–≥–¥–∞"},
            {name: "–í—ã—Ç–µ–≥–æ—Ä—Å–∫–∏–π", coords: [61.0000, 36.4500], type: "municipality", population: "21686", center: "–≥. –í—ã—Ç–µ–≥—Ä–∞"},
            {name: "–ì—Ä—è–∑–æ–≤–µ—Ü–∫–∏–π", coords: [58.8833, 40.2500], type: "municipality", population: "31398", center: "–≥. –ì—Ä—è–∑–æ–≤–µ—Ü"},
            {name: "–ö–∞–¥—É–π—Å–∫–∏–π", coords: [59.2000, 37.1500], type: "municipality", population: "16316", center: "–ø. –ö–∞–¥—É–π"},
            {name: "–ö–∏—Ä–∏–ª–ª–æ–≤—Å–∫–∏–π", coords: [59.8667, 38.3833], type: "municipality", population: "13795", center: "–≥. –ö–∏—Ä–∏–ª–ª–æ–≤"},
            {name: "–ö–∏—á–º–µ–Ω–≥—Å–∫–æ-–ì–æ—Ä–æ–¥–µ—Ü–∫–∏–π", coords: [59.9833, 45.7833], type: "municipality", population: "14079", center: "—Å. –ö–∏—á–º–µ–Ω–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"},
            {name: "–ú–µ–∂–¥—É—Ä–µ—á–µ–Ω—Å–∫–∏–π", coords: [59.2500, 40.6667], type: "municipality", population: "4740", center: "—Å. –®—É–π—Å–∫–æ–µ"},
            {name: "–ù–∏–∫–æ–ª—å—Å–∫–∏–π", coords: [59.5333, 45.4500], type: "municipality", population: "18390", center: "–≥. –ù–∏–∫–æ–ª—å—Å–∫"},
            {name: "–ù—é–∫—Å–µ–Ω—Å–∫–∏–π", coords: [60.4167, 44.2333], type: "municipality", population: "8316", center: "—Å. –ù—é–∫—Å–µ–Ω–∏—Ü–∞"},
            {name: "–°–æ–∫–æ–ª—å—Å–∫–∏–π", coords: [59.4667, 40.1167], type: "municipality", population: "44172", center: "–≥. –°–æ–∫–æ–ª"},
            {name: "–°—è–º–∂–µ–Ω—Å–∫–∏–π", coords: [60.0167, 41.0667], type: "municipality", population: "7880", center: "—Å. –°—è–º–∂–∞"},
            {name: "–¢–∞—Ä–Ω–æ–≥—Å–∫–∏–π", coords: [60.5000, 43.5833], type: "municipality", population: "10250", center: "—Å. –¢–∞—Ä–Ω–æ–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"},
            {name: "–¢–æ—Ç–µ–º—Å–∫–∏–π", coords: [59.9833, 42.7667], type: "municipality", population: "21802", center: "–≥. –¢–æ—Ç—å–º–∞"},
            {name: "–£—Å—Ç—å-–ö—É–±–∏–Ω—Å–∫–∏–π", coords: [59.6500, 39.7167], type: "municipality", population: "7154", center: "—Å. –£—Å—Ç—å–µ"},
            {name: "–£—Å—Ç—é–∂–µ–Ω—Å–∫–∏–π", coords: [58.8333, 36.4333], type: "municipality", population: "15048", center: "–≥. –£—Å—Ç—é–∂–Ω–∞"},
            {name: "–•–∞—Ä–æ–≤—Å–∫–∏–π", coords: [59.9500, 40.2000], type: "municipality", population: "12618", center: "–≥. –•–∞—Ä–æ–≤—Å–∫"},
            {name: "–ß–∞–≥–æ–¥–æ—â–µ–Ω—Å–∫–∏–π", coords: [59.1667, 35.3333], type: "municipality", population: "10732", center: "–ø. –ß–∞–≥–æ–¥–∞"},
            {name: "–ß–µ—Ä–µ–ø–æ–≤–µ—Ü–∫–∏–π", coords: [59.0000, 38.0000], type: "municipality", population: "39308", center: "–≥. –ß–µ—Ä–µ–ø–æ–≤–µ—Ü"},
            {name: "–®–µ–∫—Å–Ω–∏–Ω—Å–∫–∏–π", coords: [59.2167, 38.5000], type: "municipality", population: "28791", center: "–ø. –®–µ–∫—Å–Ω–∞"}
        ];

        const markers = [];
        let currentMarkers = [];
        let regionRectangle = null;
        let currentFilter = 'all';
        let riskOverlay = null;
        let currentRiskData = {};
        let riskOverlayVisible = true;
        let autoUpdateInterval = null;
        let brigadeMarkers = [];
        let brigadesVisible = true;
        let brigadeIntervals = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([59.2181, 39.8886], 8);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
        const vologdaRegionBounds = [
            [58.2, 34.5],  // —é–≥–æ-–∑–∞–ø–∞–¥
            [58.2, 48.0],  // —é–≥–æ-–≤–æ—Å—Ç–æ–∫
            [62.0, 48.0],  // —Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫
            [62.0, 34.5]   // —Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥
        ];

        // –ó–æ–Ω—ã —Ä–∏—Å–∫–∞ –¥–ª—è –≤—Å–µ–π –æ–±–ª–∞—Å—Ç–∏ (—Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–µ—Ç–∫—É)
        let riskGrid = createRiskGrid();

        function createRiskGrid() {
            const grid = [];
            const bounds = vologdaRegionBounds;
            const southWest = bounds[0];
            const northEast = bounds[2];

            const latStep = 0.3;
            const lngStep = 0.5;

            for (let lat = southWest[0]; lat < northEast[0]; lat += latStep) {
                for (let lng = southWest[1]; lng < northEast[1]; lng += lngStep) {
                    grid.push({
                        bounds: [
                            [lat, lng],
                            [lat + latStep, lng + lngStep]
                        ],
                        riskLevel: 2,
                        baseRisk: calculateBaseRisk(lat, lng)
                    });
                }
            }
            return grid;
        }

        function calculateBaseRisk(lat, lng) {
            let risk = 2;
            if (lat > 60.5) risk += 2;
            if (lng < 40) risk += 1;
            if (lat > 59 && lat < 60.5 && lng > 39 && lng < 42) risk += 1;
            if (lat < 59.5) risk += 1;
            return Math.min(10, risk);
        }

        // –¶–≤–µ—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Ä–∏—Å–∫–∞
        const riskColors = {
            0: '#28a745', 1: '#28a745', 2: '#28a745', 3: '#28a745',
            4: '#ffc107', 5: '#ffc107', 6: '#ffc107',
            7: '#fd7e14', 8: '#fd7e14',
            9: '#dc3545', 10: '#dc3545'
        };

        // –¢–µ–∫—Å—Ç—ã –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Ä–∏—Å–∫–∞
        const riskTexts = {
            0: '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π', 1: '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π', 2: '–ù–∏–∑–∫–∏–π', 3: '–ù–∏–∑–∫–∏–π',
            4: '–£–º–µ—Ä–µ–Ω–Ω—ã–π', 5: '–°—Ä–µ–¥–Ω–∏–π', 6: '–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π',
            7: '–í—ã—Å–æ–∫–∏–π', 8: '–í—ã—Å–æ–∫–∏–π',
            9: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', 10: '–ß—Ä–µ–∑–≤—ã—á–∞–π–Ω—ã–π'
        };

        // –î–µ–º–æ-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã API
        function getDemoWeatherData() {
            return {
                "timestamp": new Date().toISOString(),
                "municipalities": municipalities.map(m => ({
                    "name": m.name,
                    "risk_level": Math.floor(Math.random() * 4) + 2,
                    "weather": {
                        "wind": parseFloat((Math.random() * 10 + 2).toFixed(1)),
                        "temperature": parseFloat((Math.random() * 15 - 5).toFixed(1)),
                        "precipitation": parseFloat((Math.random() * 3).toFixed(1)),
                        "humidity": Math.floor(Math.random() * 30 + 60),
                        "pressure": parseFloat((Math.random() * 40 + 1000).toFixed(1))
                    },
                    "coordinates": m.coords,
                    "from_api": false
                })),
                "data_source": "demo"
            };
        }

        function getDemoRiskMatrix() {
            return {
                "timestamp": new Date().toISOString(),
                "grid": riskGrid.map(cell => ({
                    ...cell,
                    "riskLevel": Math.floor(Math.random() * 4) + 2
                })),
                "bounds": vologdaRegionBounds
            };
        }

        function showApiStatus(status, message) {
            const statusElement = document.getElementById('apiStatus');
            statusElement.innerHTML = message;
            statusElement.className = `api-status status-${status}`;
            statusElement.style.display = 'block';
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'inline-block' : 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∏—Å–∫–∞—Ö
        async function initializeRiskData() {
            const demoData = getDemoWeatherData();

            municipalities.forEach(municipality => {
                const demoMunicipality = demoData.municipalities.find(m => m.name === municipality.name);
                if (demoMunicipality) {
                    currentRiskData[municipality.name] = {
                        riskLevel: demoMunicipality.risk_level,
                        weather: demoMunicipality.weather,
                        fromApi: false,
                        damages: 0,
                        workingBrigades: 0
                    };
                }
            });

            const riskMatrix = getDemoRiskMatrix();
            riskGrid = riskMatrix.grid;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±—Ä–∏–≥–∞–¥—ã
            initBrigades();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function updateWeatherData() {
            showLoading(true);
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const response = await fetch('/api/weather/update');
                if (!response.ok) throw new Error('API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');

                const data = await response.json();

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
                municipalities.forEach(municipality => {
                    const apiMunicipality = data.municipalities.find(m => m.name === municipality.name);
                    if (apiMunicipality) {
                        currentRiskData[municipality.name] = {
                            riskLevel: apiMunicipality.risk_level,
                            weather: apiMunicipality.weather,
                            fromApi: apiMunicipality.from_api,
                            damages: calculateDamages(municipality, apiMunicipality.risk_level),
                            workingBrigades: calculateWorkingBrigades(municipality, apiMunicipality.risk_level)
                        };
                    }
                });

                // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É —Ä–∏—Å–∫–æ–≤
                const riskResponse = await fetch('/api/risk/matrix');
                if (riskResponse.ok) {
                    const riskData = await riskResponse.json();
                    riskGrid = riskData.grid; // –û–ë–ù–û–í–õ–Ø–ï–ú –°–ï–¢–ö–£ –†–ò–°–ö–û–í
                }

                updatePopups();
                createRiskOverlay(); // –ü–ï–†–ï–°–û–ó–î–ê–ï–ú OVERLAY –° –ù–û–í–´–ú–ò –î–ê–ù–ù–´–ú–ò
                renderMunicipalitiesList();
                updateBrigades();

                if (data.data_source === 'realtime') {
                    showApiStatus('online', `‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${data.successful_requests}/${data.total_requests})`);
                } else {
                    showApiStatus('offline', '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showApiStatus('offline', '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                showLoading(false);
            }
        }

        // –†–∞—Å—á–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞ –∏ —Ç–∏–ø–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
        function calculateDamages(municipality, riskLevel) {
            const baseMultiplier = municipality.type === 'city' ? 2 : 1;
            const populationFactor = Math.sqrt(parseInt(municipality.population) / 10000);
            
            if (riskLevel <= 3) return 0; // –û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è - –Ω–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π
            
            let maxDamages;
            if (riskLevel <= 6) {
                maxDamages = 5; // –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ
            } else if (riskLevel <= 8) {
                maxDamages = 10; // –ü–ª–æ—Ö–∏–µ
            } else {
                maxDamages = 17; // –û–ø–∞—Å–Ω—ã–µ
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π 20
            const calculated = Math.floor(Math.random() * maxDamages * baseMultiplier * populationFactor);
            return Math.min(20, Math.max(1, calculated)); // –ú–∏–Ω–∏–º—É–º 1, –º–∞–∫—Å–∏–º—É–º 20
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –±—Ä–∏–≥–∞–¥
        function calculateWorkingBrigades(municipality, riskLevel) {
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–∏–≥–∞–¥ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—É
            let baseBrigades = 1; // –ú–∏–Ω–∏–º—É–º 1 –±—Ä–∏–≥–∞–¥–∞ –≤ –∫–∞–∂–¥–æ–º –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–µ
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±—Ä–∏–≥–∞–¥—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –≥–æ—Ä–æ–¥–æ–≤
            if (municipality.name === "–í–æ–ª–æ–≥–¥–∞" || municipality.name === "–ß–µ—Ä–µ–ø–æ–≤–µ—Ü" || municipality.name === "–í–µ–ª–∏–∫–æ—É—Å—Ç—é–≥—Å–∫–∏–π") {
                baseBrigades = 2;
            }
            
            if (riskLevel <= 3) return 0; // –û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è - –±—Ä–∏–≥–∞–¥—ã –Ω–µ –Ω—É–∂–Ω—ã
            
            const baseMultiplier = municipality.type === 'city' ? 1.5 : 1;
            const populationFactor = Math.sqrt(parseInt(municipality.population) / 50000);
            
            if (riskLevel <= 6) {
                // –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ - –±—Ä–∏–≥–∞–¥—ã –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è–º, –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ baseBrigades
                const calculated = Math.floor(Math.random() * 4 * baseMultiplier * populationFactor);
                return Math.max(baseBrigades, calculated);
            }
            if (riskLevel <= 8) {
                // –ü–ª–æ—Ö–∏–µ
                const calculated = Math.floor(Math.random() * 6 * baseMultiplier * populationFactor);
                return Math.max(baseBrigades, calculated);
            }
            // –û–ø–∞—Å–Ω—ã–µ
            const calculated = Math.floor(Math.random() * 8 * baseMultiplier * populationFactor);
            return Math.max(baseBrigades, calculated);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
        function applyWeatherScenario(scenario) {
            showApiStatus('offline', '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');

            switch(scenario) {
                case 'excellent':
                    applyExcellentConditions();
                    break;
                case 'satisfactory':
                    applySatisfactoryConditions();
                    break;
                case 'poor':
                    applyPoorConditions();
                    break;
                case 'dangerous':
                    applyDangerousConditions();
                    break;
                case 'gradient':
                    applyGradientConditions();
                    break;
            }

            updatePopups();
            createRiskOverlay();
            renderMunicipalitiesList();
            updateBrigades();
        }

        // –û—Ç–ª–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è - –≤—Å—ë –∑–µ–ª–µ–Ω–æ–µ
        function applyExcellentConditions() {
            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                riskData.riskLevel = 2;
                riskData.weather = {
                    wind: 2,
                    temperature: 5,
                    precipitation: 0,
                    humidity: 60,
                    pressure: 1013.0
                };
                riskData.fromApi = false;
                riskData.damages = 0;
                riskData.workingBrigades = 0;
            });
            updateRiskGridUniform(2);
        }

        // –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è - –≤—Å—ë –∂–µ–ª—Ç–æ–µ
        function applySatisfactoryConditions() {
            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                riskData.riskLevel = 5;
                riskData.weather = {
                    wind: 8,
                    temperature: -2,
                    precipitation: 2,
                    humidity: 75,
                    pressure: 1005.0
                };
                riskData.fromApi = false;
                riskData.damages = calculateDamages(municipality, 5);
                riskData.workingBrigades = calculateWorkingBrigades(municipality, 5);
            });
            updateRiskGridUniform(5);
        }

        // –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è - –≤—Å—ë –æ—Ä–∞–Ω–∂–µ–≤–æ–µ
        function applyPoorConditions() {
            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                riskData.riskLevel = 7;
                riskData.weather = {
                    wind: 12,
                    temperature: -8,
                    precipitation: 5,
                    humidity: 85,
                    pressure: 995.0
                };
                riskData.fromApi = false;
                riskData.damages = calculateDamages(municipality, 7);
                riskData.workingBrigades = calculateWorkingBrigades(municipality, 7);
            });
            updateRiskGridUniform(7);
        }

        // –û–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è - –≤—Å—ë –∫—Ä–∞—Å–Ω–æ–µ
        function applyDangerousConditions() {
            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                riskData.riskLevel = 9;
                riskData.weather = {
                    wind: 18,
                    temperature: -15,
                    precipitation: 10,
                    humidity: 90,
                    pressure: 985.0
                };
                riskData.fromApi = false;
                riskData.damages = calculateDamages(municipality, 9);
                riskData.workingBrigades = calculateWorkingBrigades(municipality, 9);
            });
            updateRiskGridUniform(9);
        }

        // –í—Å–µ —Ç–∏–ø—ã –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π - –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã
        function applyGradientConditions() {
            const westLng = 34.5;
            const eastLng = 48.0;
            const totalWidth = eastLng - westLng;
            const stripeWidth = totalWidth / 4;

            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                const lng = municipality.coords[1];
                const positionFromWest = lng - westLng;
                let riskLevel;

                if (positionFromWest < stripeWidth) riskLevel = 9;
                else if (positionFromWest < stripeWidth * 2) riskLevel = 7;
                else if (positionFromWest < stripeWidth * 3) riskLevel = 5;
                else riskLevel = 2;

                riskData.riskLevel = riskLevel;
                riskData.weather = getWeatherForRiskLevel(riskData.riskLevel);
                riskData.fromApi = false;
                riskData.damages = calculateDamages(municipality, riskLevel);
                riskData.workingBrigades = calculateWorkingBrigades(municipality, riskLevel);
            });
            updateRiskGridStripes();
        }

        function getWeatherForRiskLevel(riskLevel) {
            switch(riskLevel) {
                case 2: return { wind: 2, temperature: 5, precipitation: 0, humidity: 60, pressure: 1013.0 };
                case 3: case 4: return { wind: 4, temperature: 2, precipitation: 1, humidity: 65, pressure: 1008.0 };
                case 5: case 6: return { wind: 8, temperature: -2, precipitation: 2, humidity: 75, pressure: 1005.0 };
                case 7: case 8: return { wind: 12, temperature: -8, precipitation: 5, humidity: 85, pressure: 995.0 };
                case 9: case 10: return { wind: 18, temperature: -15, precipitation: 10, humidity: 90, pressure: 985.0 };
                default: return { wind: 5, temperature: 0, precipitation: 1, humidity: 70, pressure: 1010.0 };
            }
        }

        function updateRiskGridUniform(riskLevel) {
            riskGrid.forEach(cell => {
                cell.riskLevel = riskLevel;
            });
        }

        function updateRiskGridStripes() {
            const westLng = 34.5;
            const eastLng = 48.0;
            const totalWidth = eastLng - westLng;
            const stripeWidth = totalWidth / 4;

            riskGrid.forEach(cell => {
                const centerLng = (cell.bounds[0][1] + cell.bounds[1][1]) / 2;
                const positionFromWest = centerLng - westLng;
                let riskLevel;

                if (positionFromWest < stripeWidth) riskLevel = 9;
                else if (positionFromWest < stripeWidth * 2) riskLevel = 7;
                else if (positionFromWest < stripeWidth * 3) riskLevel = 5;
                else riskLevel = 2;

                cell.riskLevel = riskLevel;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—Ä–∏–≥–∞–¥
        function initBrigades() {
            updateBrigades();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
        function updateBrigades() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–≤–∏–∂–µ–Ω–∏—è
            brigadeIntervals.forEach(interval => clearInterval(interval));
            brigadeIntervals = [];

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—Ä–∏–≥–∞–¥—ã
            brigadeMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            brigadeMarkers = [];

            // –î–æ–±–∞–≤–ª—è–µ–º –±—Ä–∏–≥–∞–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
            municipalities.forEach(municipality => {
                const riskData = currentRiskData[municipality.name];
                const brigadeCount = riskData.workingBrigades;

                if (brigadeCount > 0) {
                    // –°–æ–∑–¥–∞–µ–º –±—Ä–∏–≥–∞–¥—ã –≤–æ–∫—Ä—É–≥ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
                    for (let i = 0; i < brigadeCount; i++) {
                        const offsetLat = (Math.random() - 0.5) * 0.05;
                        const offsetLng = (Math.random() - 0.5) * 0.05;
                        
                        const brigadeCoords = [
                            municipality.coords[0] + offsetLat,
                            municipality.coords[1] + offsetLng
                        ];

                        let iconClass, iconHtml;
                        if (i === 0) {
                            iconClass = 'brigade-icon';
                            iconHtml = 'üöó';
                        } else if (i === 1) {
                            iconClass = 'brigade-icon-2';
                            iconHtml = 'üîß';
                        } else {
                            iconClass = 'brigade-icon-3';
                            iconHtml = '‚ö°';
                        }

                        const brigadeIcon = L.divIcon({
                            className: iconClass,
                            html: iconHtml,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        const brigadeMarker = L.marker(brigadeCoords, { 
                            icon: brigadeIcon,
                            zIndexOffset: 1000
                        }).addTo(map);

                        // –°–æ–∑–¥–∞–µ–º –ø–æ–ø–∞–ø –¥–ª—è –±—Ä–∏–≥–∞–¥—ã
                        const brigadePopup = `
                            <div class="risk-popup">
                                <b>–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ${i + 1}</b><br>
                                <div class="risk-details">
                                    <div class="risk-factor">
                                        <span>–†–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</span>
                                        <span>${getBrigadeStatus()}</span>
                                    </div>
                                    <div class="risk-factor">
                                        <span>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç:</span>
                                        <span>${municipality.name}</span>
                                    </div>
                                    <div class="risk-factor">
                                        <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫:</span>
                                        <span>4</span>
                                    </div>
                                    <div class="risk-factor">
                                        <span>–°—Ç–∞—Ç—É—Å:</span>
                                        <span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                    </div>
                                </div>
                            </div>
                        `;

                        brigadeMarker.bindPopup(brigadePopup);
                        brigadeMarkers.push(brigadeMarker);

                        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –±—Ä–∏–≥–∞–¥—ã
                        startBrigadeMovement(brigadeMarker, municipality, i + 1);
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±—Ä–∏–≥–∞–¥
            updateBrigadesVisibility();
        }

        // –î–≤–∏–∂–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã
        function startBrigadeMovement(marker, municipality, brigadeNumber) {
            const baseCoords = municipality.coords;
            let currentCoords = marker.getLatLng();
            
            // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–≤–∏–∂–µ–Ω–∏—è - —Ä–∞–∑–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±—Ä–∏–≥–∞–¥
            const speed = 3000 + Math.random() * 4000; // 3-7 —Å–µ–∫—É–Ω–¥
            
            const interval = setInterval(() => {
                if (!brigadesVisible) return;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const currentLatLng = marker.getLatLng();
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (–Ω–µ–±–æ–ª—å—à–æ–µ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
                const latOffset = (Math.random() - 0.5) * 0.02;
                const lngOffset = (Math.random() - 0.5) * 0.02;
                
                // –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–π–æ–Ω–æ–º –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞)
                let newLat = currentLatLng.lat + latOffset;
                let newLng = currentLatLng.lng + lngOffset;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ —Ä–∞–π–æ–Ω–æ–º –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞ (¬±0.1 –≥—Ä–∞–¥—É—Å–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞)
                const maxOffset = 0.1;
                newLat = Math.max(baseCoords[0] - maxOffset, Math.min(baseCoords[0] + maxOffset, newLat));
                newLng = Math.max(baseCoords[1] - maxOffset, Math.min(baseCoords[1] + maxOffset, newLng));
                
                // –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –º–∞—Ä–∫–µ—Ä
                marker.setLatLng([newLat, newLng]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ø–æ–ø–∞–ø–µ
                const newStatus = getBrigadeStatus();
                const popupContent = `
                    <div class="risk-popup">
                        <b>–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ${brigadeNumber}</b><br>
                        <div class="risk-details">
                            <div class="risk-factor">
                                <span>–†–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</span>
                                <span>${newStatus}</span>
                            </div>
                            <div class="risk-factor">
                                <span>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç:</span>
                                <span>${municipality.name}</span>
                            </div>
                            <div class="risk-factor">
                                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫:</span>
                                <span>4</span>
                            </div>
                            <div class="risk-factor">
                                <span>–°—Ç–∞—Ç—É—Å:</span>
                                <span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                            </div>
                        </div>
                    </div>
                `;
                
                marker.setPopupContent(popupContent);
                
            }, speed);
            
            brigadeIntervals.push(interval);
        }

        function getBrigadeStatus() {
            const statuses = [
                "–ü—Ä–æ–≤–æ–¥–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É",
                "–í—ã–µ—Ö–∞–ª–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç", 
                "–í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
                "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "–û—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–ì–æ—Ç–æ–≤–∞ –∫ –≤—ã–µ–∑–¥—É",
                "–ù–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ",
                "–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É"
            ];
            return statuses[Math.floor(Math.random() * statuses.length)];
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±—Ä–∏–≥–∞–¥
        function toggleBrigades() {
            const btn = document.getElementById('toggleBrigadesBtn');
            
            if (brigadesVisible) {
                brigadeMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
                btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –±—Ä–∏–≥–∞–¥—ã';
                brigadesVisible = false;
            } else {
                brigadeMarkers.forEach(marker => {
                    marker.addTo(map);
                });
                btn.textContent = '–°–∫—Ä—ã—Ç—å –±—Ä–∏–≥–∞–¥—ã';
                brigadesVisible = true;
            }
        }

        function updateBrigadesVisibility() {
            if (brigadesVisible) {
                brigadeMarkers.forEach(marker => {
                    marker.addTo(map);
                });
            } else {
                brigadeMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ overlay —Å –∑–∞–∫—Ä–∞—Å–∫–æ–π –≤—Å–µ–π –æ–±–ª–∞—Å—Ç–∏
        function createRiskOverlay() {
            if (riskOverlay) {
                map.removeLayer(riskOverlay);
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 1000;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            function latLngToPixel(lat, lng) {
                const point = map.latLngToContainerPoint([lat, lng]);
                return {
                    x: (point.x / map.getSize().x) * canvas.width,
                    y: (point.y / map.getSize().y) * canvas.height
                };
            }

            riskGrid.forEach(cell => {
                const cellBounds = cell.bounds;
                const cellTopLeft = latLngToPixel(cellBounds[1][0], cellBounds[0][1]);
                const cellBottomRight = latLngToPixel(cellBounds[0][0], cellBounds[1][1]);

                const color = riskColors[cell.riskLevel];
                const width = cellBottomRight.x - cellTopLeft.x;
                const height = cellBottomRight.y - cellTopLeft.y;

                if (width > 0 && height > 0) {
                    ctx.fillStyle = color + 'aa';
                    ctx.fillRect(cellTopLeft.x, cellTopLeft.y, width, height);
                }
            });

            riskOverlay = L.imageOverlay(canvas.toDataURL(), vologdaRegionBounds, {
                opacity: 0.7,
                interactive: true
            }).addTo(map);

            riskOverlay.on('click', function(e) {
                const point = e.latlng;
                showRegionPopup(point);
            });
        }

        // –ü–æ–∫–∞–∑ –ø–æ–ø–∞–ø–∞ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞
        function showRegionPopup(point) {
            const cell = findCellAtPoint(point);
            const nearestMunicipality = findNearestMunicipality(point.lat, point.lng);

            let riskLevel = cell ? cell.riskLevel : 2;
            let weatherData = {
                wind: 3,
                temperature: -5,
                precipitation: 0.5,
                humidity: 80,
                pressure: 1013.0
            };
            let fromApi = false;
            let damages = 0;
            let workingBrigades = 0;

            if (nearestMunicipality) {
                const municipalityRisk = currentRiskData[nearestMunicipality.name];
                riskLevel = municipalityRisk.riskLevel;
                weatherData = municipalityRisk.weather;
                fromApi = municipalityRisk.fromApi || false;
                damages = municipalityRisk.damages || 0;
                workingBrigades = municipalityRisk.workingBrigades || 0;
            }

            const color = riskColors[riskLevel];
            const riskText = riskTexts[riskLevel];

            const popupContent = `
                <div class="risk-popup">
                    <div class="risk-level" style="background-color: ${color};">${riskText} —Ä–∏—Å–∫</div>
                    <b>–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</b><br>
                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}<br>
                    ${nearestMunicipality ? `–ë–ª–∏–∂–∞–π—à–∏–π —Ä–∞–π–æ–Ω: ${nearestMunicipality.name}<br>` : ''}
                    ${fromApi ? '<small>‚úÖ –î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</small><br>' : '<small>‚ö†Ô∏è –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</small><br>'}
                    <div class="risk-details">
                        <div class="risk-factor">
                            <span>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</span>
                            <span>${riskLevel}/10</span>
                        </div>
                        <div class="risk-factor">
                            <span>–í–µ—Ç–µ—Ä:</span>
                            <span>${weatherData.wind} –º/—Å</span>
                        </div>
                        <div class="risk-factor">
                            <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
                            <span>${weatherData.temperature}¬∞C</span>
                        </div>
                        <div class="risk-factor">
                            <span>–û—Å–∞–¥–∫–∏:</span>
                            <span>${weatherData.precipitation} –º–º/—á</span>
                        </div>
                        <div class="risk-factor">
                            <span>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</span>
                            <span>${weatherData.humidity}%</span>
                        </div>
                        <div class="risk-factor">
                            <span>–î–∞–≤–ª–µ–Ω–∏–µ:</span>
                            <span>${weatherData.pressure} hPa</span>
                        </div>
                        ${damages > 0 || workingBrigades > 0 ? `
                        <div class="damage-stats">
                            <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π:</b>
                            <div class="damage-item">
                                <span>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –õ–≠–ü:</span>
                                <span class="damage-count ${damages > 10 ? 'damage-high' : damages > 5 ? 'damage-medium' : 'damage-low'}">${damages}</span>
                            </div>
                            <div class="damage-item">
                                <span>–†–∞–±–æ—Ç–∞—é—â–∏–µ –±—Ä–∏–≥–∞–¥—ã:</span>
                                <span class="damage-count">${workingBrigades}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            L.popup()
                .setLatLng(point)
                .setContent(popupContent)
                .openOn(map);
        }

        // –ü–æ–∏—Å–∫ —è—á–µ–π–∫–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        function findCellAtPoint(point) {
            return riskGrid.find(cell => {
                const bounds = cell.bounds;
                return point.lat >= bounds[0][0] && point.lat <= bounds[1][0] &&
                       point.lng >= bounds[0][1] && point.lng <= bounds[1][1];
            });
        }

        // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
        function findNearestMunicipality(lat, lng) {
            let nearest = null;
            let minDistance = Infinity;

            municipalities.forEach(municipality => {
                const distance = Math.sqrt(
                    Math.pow(municipality.coords[0] - lat, 2) +
                    Math.pow(municipality.coords[1] - lng, 2)
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = municipality;
                }
            });

            return nearest;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ overlay
        function toggleRiskOverlay() {
            const btn = document.getElementById('toggleRiskOverlayBtn');

            if (riskOverlayVisible) {
                map.removeLayer(riskOverlay);
                btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å overlay';
                riskOverlayVisible = false;
            } else {
                riskOverlay.addTo(map);
                btn.textContent = '–°–∫—Ä—ã—Ç—å overlay';
                riskOverlayVisible = true;
            }
        }

        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
        function createMarkers() {
            markers.length = 0;

            municipalities.forEach(municipality => {
                let iconClass, iconSize;

                if (municipality.type === 'city') {
                    if (municipality.name === '–í–æ–ª–æ–≥–¥–∞') {
                        iconClass = 'vologda-dot';
                        iconSize = [14, 14];
                    } else {
                        iconClass = 'cherepovets-dot';
                        iconSize = [14, 14];
                    }
                } else {
                    iconClass = 'municipality-dot';
                    iconSize = [10, 10];
                }

                const customIcon = L.divIcon({
                    className: iconClass,
                    iconSize: iconSize,
                    iconAnchor: [iconSize[0]/2, iconSize[1]/2]
                });

                const marker = L.marker(municipality.coords, { icon: customIcon })
                    .bindPopup(createMunicipalityPopup(municipality));

                markers.push({
                    marker: marker,
                    municipality: municipality
                });
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ø–∞–ø–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
        function createMunicipalityPopup(municipality) {
            const risk = currentRiskData[municipality.name];
            const color = riskColors[risk.riskLevel];
            const riskText = riskTexts[risk.riskLevel];
            const fromApi = risk.fromApi || false;
            const damages = risk.damages || 0;
            const workingBrigades = risk.workingBrigades || 0;

            return `
                <div class="risk-popup">
                    <div class="risk-level" style="background-color: ${color};">${riskText} —Ä–∏—Å–∫</div>
                    <b>${municipality.name}</b><br>
                    ${municipality.type === 'city' ? '–ì–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥' : '–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω/–æ–∫—Ä—É–≥'}<br>
                    –ù–∞—Å–µ–ª–µ–Ω–∏–µ: ${formatPopulation(municipality.population)}<br>
                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä: ${municipality.center}<br>
                    ${fromApi ? '<small>‚úÖ –î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</small>' : '<small>‚ö†Ô∏è –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</small>'}
                    <div class="risk-details">
                        <hr>
                        <b>–ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</b>
                        <div class="risk-factor">
                            <span>–í–µ—Ç–µ—Ä:</span>
                            <span>${risk.weather.wind} –º/—Å</span>
                        </div>
                        <div class="risk-factor">
                            <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
                            <span>${risk.weather.temperature}¬∞C</span>
                        </div>
                        <div class="risk-factor">
                            <span>–û—Å–∞–¥–∫–∏:</span>
                            <span>${risk.weather.precipitation} –º–º/—á</span>
                        </div>
                        <div class="risk-factor">
                            <span>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</span>
                            <span>${risk.weather.humidity}%</span>
                        </div>
                        <div class="risk-factor">
                            <span>–î–∞–≤–ª–µ–Ω–∏–µ:</span>
                            <span>${risk.weather.pressure} hPa</span>
                        </div>
                        ${damages > 0 || workingBrigades > 0 ? `
                        <div class="damage-stats">
                            <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π:</b>
                            <div class="damage-item">
                                <span>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –õ–≠–ü:</span>
                                <span class="damage-count ${damages > 10 ? 'damage-high' : damages > 5 ? 'damage-medium' : 'damage-low'}">${damages}</span>
                            </div>
                            <div class="damage-item">
                                <span>–†–∞–±–æ—Ç–∞—é—â–∏–µ –±—Ä–∏–≥–∞–¥—ã:</span>
                                <span class="damage-count">${workingBrigades}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ø–∞–ø–æ–≤
        function updatePopups() {
            markers.forEach(item => {
                item.marker.setPopupContent(createMunicipalityPopup(item.municipality));
            });
        }

        // –û–±–≤–µ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º
        function highlightRegion() {
            removeRegion();

            regionRectangle = L.rectangle(vologdaRegionBounds, {
                color: '#6c757d',
                weight: 3,
                fillColor: '#6c757d',
                fillOpacity: 0.05,
                opacity: 0.8
            }).addTo(map);

            map.fitBounds(regionRectangle.getBounds());
        }

        // –£–±—Ä–∞—Ç—å –æ–±–≤–æ–¥–∫—É
        function removeRegion() {
            if (regionRectangle) {
                map.removeLayer(regionRectangle);
                regionRectangle = null;
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
        function filterMunicipalities(filter) {
            currentFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(searchTerm);
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters(searchTerm = '') {
            let filtered = municipalities;

            if (currentFilter === 'municipality') {
                filtered = filtered.filter(m => m.type === 'municipality');
            } else if (currentFilter === 'city') {
                filtered = filtered.filter(m => m.type === 'city');
            }

            if (searchTerm) {
                filtered = filtered.filter(m =>
                    m.name.toLowerCase().includes(searchTerm) ||
                    m.center.toLowerCase().includes(searchTerm)
                );
            }

            renderMunicipalitiesList(filtered);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã
        function showAllMunicipalities() {
            clearMarkers();
            markers.forEach(item => {
                if (currentFilter === 'all' ||
                    (currentFilter === 'municipality' && item.municipality.type === 'municipality') ||
                    (currentFilter === 'city' && item.municipality.type === 'city')) {
                    item.marker.addTo(map);
                    currentMarkers.push(item.marker);
                }
            });

            if (currentMarkers.length > 0) {
                const bounds = L.latLngBounds(currentMarkers.map(m => m.getLatLng()));
                map.fitBounds(bounds);
            }
        }

        // –°–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—É
        function resetMap() {
            clearMarkers();
            removeRegion();
            map.setView([59.2181, 39.8886], 8);
            document.getElementById('searchInput').value = '';
            currentFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.filter-btn').classList.add('active');
            applyFilters();
            updateWeatherData();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã
        function clearMarkers() {
            currentMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentMarkers = [];
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å–µ–ª–µ–Ω–∏—è
        function formatPopulation(pop) {
            return pop.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        function showMunicipality(municipality) {
            clearMarkers();
            const found = markers.find(item => item.municipality.name === municipality.name);
            if (found) {
                found.marker.addTo(map);
                currentMarkers.push(found.marker);
                map.setView(municipality.coords, 10);
                found.marker.openPopup();
            }
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫
        function renderMunicipalitiesList(filteredMunicipalities = municipalities) {
            const list = document.getElementById('municipalityList');
            list.innerHTML = '';

            const sortedMunicipalities = [...filteredMunicipalities].sort((a, b) =>
                parseInt(b.population) - parseInt(a.population)
            );

            sortedMunicipalities.forEach(municipality => {
                const item = document.createElement('div');
                item.className = 'municipality-item';

                let typeText = municipality.type === 'city' ? '–ì–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥' : '–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω';
                let populationText = formatPopulation(municipality.population);
                const risk = currentRiskData[municipality.name];
                const color = riskColors[risk.riskLevel];
                const riskText = riskTexts[risk.riskLevel];
                const fromApi = risk.fromApi || false;
                const damages = risk.damages || 0;
                const workingBrigades = risk.workingBrigades || 0;

                item.innerHTML = `
                    <div class="municipality-name">
                        <span class="risk-indicator" style="background-color: ${color}"></span>
                        ${municipality.name}
                        ${fromApi ? '<span style="color: #28a745; font-size: 10px;"> ‚úÖ</span>' : '<span style="color: #fd7e14; font-size: 10px;"> ‚ö†Ô∏è</span>'}
                    </div>
                    <div class="municipality-info">
                        ${typeText} ‚Ä¢ –ù–∞—Å–µ–ª–µ–Ω–∏–µ: ${populationText}<br>
                        –¶–µ–Ω—Ç—Ä: ${municipality.center}<br>
                        –£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞: <span style="color: ${color}; font-weight: bold;">${riskText}</span>
                        ${damages > 0 || workingBrigades > 0 ? `
                        <div class="damage-stats">
                            <div class="damage-item">
                                <span>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è:</span>
                                <span class="damage-count ${damages > 10 ? 'damage-high' : damages > 5 ? 'damage-medium' : 'damage-low'}">${damages}</span>
                            </div>
                            <div class="damage-item">
                                <span>–ë—Ä–∏–≥–∞–¥—ã:</span>
                                <span class="damage-count">${workingBrigades}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                item.addEventListener('click', () => {
                    showMunicipality(municipality);
                });

                list.appendChild(item);
            });
        }

        // –ü–æ–∏—Å–∫
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            applyFilters(searchTerm);
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function startAutoUpdate() {
            autoUpdateInterval = setInterval(updateWeatherData, 2 * 60 * 1000); // 2 –º–∏–Ω—É—Ç—ã
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initializeRiskData().then(() => {
                createMarkers();
                createRiskOverlay();
                showAllMunicipalities();
                renderMunicipalitiesList();
                startAutoUpdate();
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ overlay –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        map.on('resize', function() {
            if (riskOverlayVisible) {
                createRiskOverlay();
            }
        });
    </script>
</body>
</html>

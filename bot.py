import logging
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import aiohttp
from typing import Dict, List
from g4f.client import Client

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!)
BOT_TOKEN = "7866642235:AAH0cC6HomjFmxAZODZ7Kea5rBFTqVkt9Uc"

# –¶–µ–Ω—Ç—Ä—ã –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤ –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
VOLOGDA_REGION_LOCATIONS = {
    # –ì–æ—Ä–æ–¥–∞
    "–±–∞–±–∞–µ–≤–æ": {"lat": 59.3833, "lon": 35.9500, "type": "–≥–æ—Ä–æ–¥"},
    "–±–µ–ª–æ–∑–µ—Ä—Å–∫": {"lat": 60.0333, "lon": 37.7833, "type": "–≥–æ—Ä–æ–¥"},
    "–≤–µ–ª–∏–∫–∏–π —É—Å—Ç—é–≥": {"lat": 60.7585, "lon": 46.3044, "type": "–≥–æ—Ä–æ–¥"},
    "–≤–æ–ª–æ–≥–¥–∞": {"lat": 59.3000, "lon": 39.9000, "type": "–≥–æ—Ä–æ–¥"},
    "–≤—ã—Ç–µ–≥—Ä–∞": {"lat": 61.0000, "lon": 36.4500, "type": "–≥–æ—Ä–æ–¥"},
    "–≥—Ä—è–∑–æ–≤–µ—Ü": {"lat": 58.8833, "lon": 40.2500, "type": "–≥–æ—Ä–æ–¥"},
    "–∫–∏—Ä–∏–ª–ª–æ–≤": {"lat": 59.8667, "lon": 38.3833, "type": "–≥–æ—Ä–æ–¥"},
    "–Ω–∏–∫–æ–ª—å—Å–∫": {"lat": 59.5333, "lon": 45.4500, "type": "–≥–æ—Ä–æ–¥"},
    "—Å–æ–∫–æ–ª": {"lat": 59.4667, "lon": 40.1167, "type": "–≥–æ—Ä–æ–¥"},
    "—Ç–æ—Ç—å–º–∞": {"lat": 59.9833, "lon": 42.7667, "type": "–≥–æ—Ä–æ–¥"},
    "—É—Å—Ç—é–∂–Ω–∞": {"lat": 58.8333, "lon": 36.4333, "type": "–≥–æ—Ä–æ–¥"},
    "—Ö–∞—Ä–æ–≤—Å–∫": {"lat": 59.9500, "lon": 40.2000, "type": "–≥–æ—Ä–æ–¥"},
    "—á–µ—Ä–µ–ø–æ–≤–µ—Ü": {"lat": 59.0000, "lon": 38.0000, "type": "–≥–æ—Ä–æ–¥"},
    
    # –ü–æ—Å–µ–ª–∫–∏
    "–≤–æ–∂–µ–≥–∞": {"lat": 60.4667, "lon": 40.2167, "type": "–ø–æ—Å–µ–ª–æ–∫"},
    "–∫–∞–¥—É–π": {"lat": 59.2000, "lon": 37.1500, "type": "–ø–æ—Å–µ–ª–æ–∫"},
    "—á–∞–≥–æ–¥–∞": {"lat": 59.1667, "lon": 35.3333, "type": "–ø–æ—Å–µ–ª–æ–∫"},
    "—à–µ–∫—Å–Ω–∞": {"lat": 59.2167, "lon": 38.5000, "type": "–ø–æ—Å–µ–ª–æ–∫"},
    
    # –°–µ–ª–∞
    "–∏–º–µ–Ω–∏ –±–∞–±—É—à–∫–∏–Ω–∞": {"lat": 59.7500, "lon": 43.1167, "type": "—Å–µ–ª–æ"},
    "–ª–∏–ø–∏–Ω –±–æ—Ä": {"lat": 60.3667, "lon": 37.9333, "type": "—Å–µ–ª–æ"},
    "–≤–µ—Ä—Ö–æ–≤–∞–∂—å–µ": {"lat": 60.7167, "lon": 41.9833, "type": "—Å–µ–ª–æ"},
    "–∫–∏—á–º–µ–Ω–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫": {"lat": 59.9833, "lon": 45.7833, "type": "—Å–µ–ª–æ"},
    "—à—É–π—Å–∫–æ–µ": {"lat": 59.2500, "lon": 40.6667, "type": "—Å–µ–ª–æ"},
    "–Ω—é–∫—Å–µ–Ω–∏—Ü–∞": {"lat": 60.4167, "lon": 44.2333, "type": "—Å–µ–ª–æ"},
    "—Å—è–º–∂–∞": {"lat": 60.0167, "lon": 41.0667, "type": "—Å–µ–ª–æ"},
    "—Ç–∞—Ä–Ω–æ–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫": {"lat": 60.5000, "lon": 43.5833, "type": "—Å–µ–ª–æ"},
    "—É—Å—Ç—å–µ": {"lat": 59.6500, "lon": 39.7167, "type": "—Å–µ–ª–æ"},
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞
    "–≤–µ–ª–∏–∫–∏–π—É—Å—Ç—é–≥": {"lat": 60.7585, "lon": 46.3044, "type": "–≥–æ—Ä–æ–¥"},
    "–∏–º –±–∞–±—É—à–∫–∏–Ω–∞": {"lat": 59.7500, "lon": 43.1167, "type": "—Å–µ–ª–æ"},
    "–∫–∏—á–º–µ–Ω–≥—Å–∫–∏–π": {"lat": 59.9833, "lon": 45.7833, "type": "—Å–µ–ª–æ"},
    "—Ç–∞—Ä–Ω–æ–≥—Å–∫–∏–π": {"lat": 60.5000, "lon": 43.5833, "type": "—Å–µ–ª–æ"},
    "–±–∞–±—É—à–∫–∏–Ω–∞": {"lat": 59.7500, "lon": 43.1167, "type": "—Å–µ–ª–æ"}
}

class WeatherAnalyzer:
    def __init__(self):
        self.base_url = "https://api.open-meteo.com/v1/forecast"
    
    async def get_weather_data(self, lat: float, lon: float) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ —Å OpenMeteo"""
        try:
            params = {
                'latitude': lat,
                'longitude': lon,
                'current': [
                    'temperature_2m', 'wind_speed_10m', 'wind_gusts_10m', 
                    'relative_humidity_2m', 'precipitation', 'weather_code',
                    'pressure_msl', 'cloud_cover'
                ],
                'timezone': 'Europe/Moscow'
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(self.base_url, params=params, timeout=10) as response:
                    response.raise_for_status()
                    return await response.json()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã: {e}")
            return None

class TerrainAnalyzer:
    """–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–∏–ø–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏"""
    
    async def analyze_terrain(self, lat: float, lon: float, location_name: str, location_type: str) -> Dict:
        """–ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏"""
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenStreetMap –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
            async with aiohttp.ClientSession() as session:
                url = f"https://nominatim.openstreetmap.org/reverse"
                params = {
                    'lat': lat,
                    'lon': lon,
                    'format': 'json',
                    'zoom': 10
                }
                
                async with session.get(url, params=params) as response:
                    if response.status == 200:
                        data = await response.json()
                        return self._parse_osm_data(data, location_name, location_type)
                    else:
                        return self._get_default_terrain(location_name, location_type)
                        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏: {e}")
            return self._get_default_terrain(location_name, location_type)
    
    def _parse_osm_data(self, osm_data: Dict, location_name: str, location_type: str) -> Dict:
        """–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö OSM"""
        address = osm_data.get('address', {})
        display_name = osm_data.get('display_name', '').lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
        terrain_type = "—Ä–∞–≤–Ω–∏–Ω–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å"
        features = []
        
        if any(word in display_name for word in ['–ª–µ—Å', 'forest', 'wood']):
            terrain_type = "–ª–µ—Å–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å"
            features.extend(['–¥–µ—Ä–µ–≤—å—è near –õ–≠–ü', '—Ä–∏—Å–∫ –ø–∞–¥–µ–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤', '–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å'])
        elif any(word in display_name for word in ['–æ–∑–µ—Ä–æ', '—Ä–µ–∫–∞', '–≤–æ–¥–æ–µ–º', 'lake', 'river']):
            terrain_type = "–ø—Ä–∏–æ–∑–µ—Ä–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å"
            features.extend(['–ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å', '—Ç—É–º–∞–Ω—ã', '–∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞'])
        elif any(word in display_name for word in ['—Ö–æ–ª–º', '–≥–æ—Ä–∞', 'hill', 'mountain']):
            terrain_type = "—Ö–æ–ª–º–∏—Å—Ç–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å"
            features.extend(['–ø–µ—Ä–µ–ø–∞–¥—ã –≤—ã—Å–æ—Ç', '—É—Å–∏–ª–µ–Ω–Ω–∞—è –≤–µ—Ç—Ä–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞'])
        elif any(word in display_name for word in ['–ø—Ä–æ–º–∑–æ–Ω–∞', '–∑–∞–≤–æ–¥', 'factory', 'industrial']):
            terrain_type = "–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –∑–æ–Ω–∞"
            features.extend(['—Ç–µ—Ö–Ω–æ–≥–µ–Ω–Ω—ã–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è', '–∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞'])
        
        return {
            'type': terrain_type,
            'features': features if features else ['—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è'],
            'description': f'{terrain_type} –≤ —Ä–∞–π–æ–Ω–µ {location_name} ({location_type})',
            'location_type': location_type
        }
    
    def _get_default_terrain(self, location_name: str, location_type: str) -> Dict:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–Ω–æ—Å—Ç–∏"""
        return {
            'type': '—Ä–∞–≤–Ω–∏–Ω–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å',
            'features': ['—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è'],
            'description': f'–û—Å–Ω–æ–≤–Ω–∞—è –º–µ—Å—Ç–Ω–æ—Å—Ç—å –≤–æ–∫—Ä—É–≥ {location_name} ({location_type})',
            'location_type': location_type
        }

class G4FGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —á–µ—Ä–µ–∑ g4f"""
    
    def __init__(self):
        self.client = Client()
    
    async def generate_recommendations(self, weather_data: Dict, terrain_data: Dict, location: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —á–µ—Ä–µ–∑ g4f"""
        prompt = self._create_prompt(weather_data, terrain_data, location)
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{"role": "user", "content": prompt}],
                web_search=False
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            return self._get_fallback_recommendations(weather_data, terrain_data, location)
    
        def _create_prompt(self, weather_data: Dict, terrain_data: Dict, location: str) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
        
        current = weather_data.get('current', {})
        
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∫–æ–¥ –ø–æ–≥–æ–¥—ã
        weather_code = current.get('weather_code', 0)
        weather_description = self._decode_weather_code(weather_code)
        
        weather_info = f"""
–†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ü–û–ì–û–î–´ –ò–ó –°–ï–†–í–ò–°–ê OpenMeteo –¥–ª—è {location.upper()}:

–ú–ï–°–¢–û–ü–û–ñ–ï–ù–ò–ï: {location.upper()} ({terrain_data.get('location_type', '–Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç')})
–¢–ò–ü –ú–ï–°–¢–ù–û–°–¢–ò: {terrain_data.get('type', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
–û–°–û–ë–ï–ù–ù–û–°–¢–ò –ú–ï–°–¢–ù–û–°–¢–ò: {', '.join(terrain_data.get('features', []))}

–¢–ï–ö–£–©–ò–ï –ü–û–ì–û–î–ù–´–ï –£–°–õ–û–í–ò–Ø (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞):
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {current.get('temperature_2m', 'N/A')}¬∞C
- –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: {current.get('wind_speed_10m', 'N/A')} –º/—Å
- –ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞: {current.get('wind_gusts_10m', 'N/A')} –º/—Å
- –í–ª–∞–∂–Ω–æ—Å—Ç—å: {current.get('relative_humidity_2m', 'N/A')}%
- –û—Å–∞–¥–∫–∏: {current.get('precipitation', 'N/A')} –º–º
- –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ: {current.get('pressure_msl', 'N/A')} –≥–ü–∞
- –û–±–ª–∞—á–Ω–æ—Å—Ç—å: {current.get('cloud_cover', 'N/A')}%
- –ü–æ–≥–æ–¥–∞: {weather_description}
"""
        
        prompt = f"""
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –ª–∏–Ω–∏–π —ç–ª–µ–∫—Ç—Ä–æ–ø–µ—Ä–µ–¥–∞—á –≤ –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏. 
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–ï–ö–£–©–ò–ï –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¢–û–õ–¨–ö–û –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ä–∏—Å–∫–∞–º.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
1. –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–û–ô –ü–û–ì–û–î–ù–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò
2. –ù–ï –î–û–ü–£–°–ö–ê–ô –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ô, –ü–†–û–ì–ù–û–ó–û–í –ò–õ–ò –í–´–ú–´–®–õ–ï–ù–ù–´–• –î–ê–ù–ù–´–•
3. –û–°–ù–û–í–´–í–ê–ô –í–´–í–û–î–´ –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –ù–ê –¶–ò–§–†–ê–• –ò –§–ê–ö–¢–ê–• –ò–ó –í–´–®–ï–ü–†–ò–í–ï–î–ï–ù–ù–´–• –î–ê–ù–ù–´–•

{weather_info}

–°–§–û–†–ú–£–õ–ò–†–£–ô –û–¢–í–ï–¢ –í –°–õ–ï–î–£–Æ–©–ï–ú –§–û–†–ú–ê–¢–ï (–ú–ê–ö–°–ò–ú–£–ú 2000 –°–ò–ú–í–û–õ–û–í):

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏–π):
- –£–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: —Å–∏–ª—å–Ω—ã–π –ø–æ—Ä—ã–≤–∏—Å—Ç—ã–π –≤–µ—Ç–µ—Ä (—Å–∫–æ—Ä–æ—Å—Ç—å > 10 –º/—Å –∏–ª–∏ –ø–æ—Ä—ã–≤—ã > 15 –º/—Å), –≥—Ä–æ–∑–æ–≤—ã–µ —è–≤–ª–µ–Ω–∏—è (–∫–æ–¥—ã –ø–æ–≥–æ–¥—ã 95, 96, 99), –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Å–Ω–µ–≥ (–∫–æ–¥—ã 71, 73, 75, 85, 86)
- –ï—Å–ª–∏ —ç—Ç–∏—Ö —è–≤–ª–µ–Ω–∏–π –Ω–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –ø–∏—à–∏ "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ—Ç"
- –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô —Ä–∏—Å–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö

üìä –í–û–ó–î–ï–ô–°–¢–í–ò–ï –ù–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–£ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö):
- –û–ø–∏—Å—ã–≤–∞–π –¢–û–õ–¨–ö–û –≤–ª–∏—è–Ω–∏–µ —Å–Ω–µ–≥–∞ –∏ –≤–µ—Ç—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∏ –ï–°–¢–¨ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
- –ï—Å–ª–∏ —Å–Ω–µ–≥–∞ –∏ –≤–µ—Ç—Ä–∞ –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ–Ω–∏ —Å–ª–∞–±—ã–µ - –ø—Ä–æ–ø—É—Å–∫–∞–π —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª
- –ù–ï –ü–†–ï–î–ü–û–õ–ê–ì–ê–ô –≤–æ–∑–º–æ–∂–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ

üë∑‚Äç‚ôÇÔ∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ë–†–ò–ì–ê–î–ê–ú (–¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö):
- 3-4 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã

üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è):
- –¢–û–õ–¨–ö–û –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∞–≤–∞—Ä–∏–∏: –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–∞—á–∞–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç
- –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —É–∫–∞–∂–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

‚ö†Ô∏è –ê–í–ê–†–ò–ô–ù–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨ (—É—á–∏—Ç—ã–≤–∞—è —Ä–µ–∞–ª—å–Ω—É—é —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É):
- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ä—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –≤–æ–∑–º–æ–∂–Ω—ã–º —Å–±–æ—è–º –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—É—é —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ù–ï –¥–µ–ª–∞–π –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –±—É–¥—É—â–µ–π –ø–æ–≥–æ–¥–µ
3. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–Ω–∞–Ω–∏—è –æ —Ç–∏–ø–∏—á–Ω–æ–π –ø–æ–≥–æ–¥–µ —Ä–µ–≥–∏–æ–Ω–∞ - —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
4. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–µ—Ç—Ä–µ, –≥—Ä–æ–∑–∞—Ö –∏ —Å–Ω–µ–≥–µ –ò–ó –†–ï–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–•
5. –ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–ø–æ–∫–æ–π–Ω—É—é –ø–æ–≥–æ–¥—É - —Ç–∞–∫ –∏ —É–∫–∞–∑—ã–≤–∞–π
6. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –ø—Ä–∞–∫—Ç–∏—á–µ–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö
7. –û–≥—Ä–∞–Ω–∏—á—å –æ—Ç–≤–µ—Ç 2000 —Å–∏–º–≤–æ–ª–∞–º–∏
8. –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–≥–æ–¥–Ω—ã—Ö —è–≤–ª–µ–Ω–∏–π –Ω–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º
"""
        return prompt
    
    def _decode_weather_code(self, code: int) -> str:
        """–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø–æ–≥–æ–¥—ã WMO"""
        weather_codes = {
            0: "–Ø—Å–Ω–æ",
            1: "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ",
            2: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",
            3: "–ü–∞—Å–º—É—Ä–Ω–æ",
            45: "–¢—É–º–∞–Ω",
            48: "–¢—É–º–∞–Ω —Å –∏–∑–º–æ—Ä–æ–∑—å—é",
            51: "–õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å",
            53: "–£–º–µ—Ä–µ–Ω–Ω–∞—è –º–æ—Ä–æ—Å—å", 
            55: "–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å",
            61: "–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å",
            63: "–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å",
            65: "–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
            71: "–ù–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥",
            73: "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥",
            75: "–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥",
            77: "–°–Ω–µ–∂–Ω—ã–µ –∑–µ—Ä–Ω–∞",
            80: "–ù–µ–±–æ–ª—å—à–∏–µ –ª–∏–≤–Ω–∏",
            81: "–£–º–µ—Ä–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏",
            82: "–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏",
            85: "–ù–µ–±–æ–ª—å—à–∏–µ —Å–Ω–µ–≥–æ–ø–∞–¥—ã",
            86: "–°–∏–ª—å–Ω—ã–µ —Å–Ω–µ–≥–æ–ø–∞–¥—ã",
            95: "–ì—Ä–æ–∑–∞",
            96: "–ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º",
            99: "–°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º"
        }
        return weather_codes.get(code, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    
        def _get_fallback_recommendations(self, weather_data: Dict, terrain_data: Dict, location: str) -> str:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –µ—Å–ª–∏ g4f –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"""
        current = weather_data.get('current', {})
        temp = current.get('temperature_2m', 0)
        wind = current.get('wind_speed_10m', 0)
        gusts = current.get('wind_gusts_10m', 0)
        humidity = current.get('relative_humidity_2m', 0)
        weather_code = current.get('weather_code', 0)
        precipitation = current.get('precipitation', 0)
        
        # –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö
        critical_risks = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Ç—Ä–µ
        if wind > 10 or gusts > 15:
            critical_risks.append(f"üí® –°–ò–õ–¨–ù–´–ô –ü–û–†–´–í–ò–°–¢–´–ô –í–ï–¢–ï–† ({wind} –º/—Å, –ø–æ—Ä—ã–≤—ã {gusts} –º/—Å)")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –≥—Ä–æ–∑–æ–≤—ã—Ö —è–≤–ª–µ–Ω–∏–π
        if weather_code in [95, 96, 99]:
            critical_risks.append("‚ö° –ì–†–û–ó–û–í–´–ï –Ø–í–õ–ï–ù–ò–Ø (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ —Å–Ω–µ–≥–∞
        if weather_code in [71, 73, 75, 85, 86]:
            critical_risks.append(f"‚ùÑÔ∏è –ò–ù–¢–ï–ù–°–ò–í–ù–´–ô –°–ù–ï–ì (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {precipitation} –º–º)")
        
        # –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö
        infrastructure_impact = []
        if wind > 10:
            infrastructure_impact.extend([
                f"‚Ä¢ –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ–ø–æ—Ä—ã –∏ –ø—Ä–æ–≤–æ–¥–∞ (–≤–µ—Ç–µ—Ä {wind} –º/—Å)",
                "‚Ä¢ –†–∏—Å–∫ —Å—Ö–ª–µ—Å—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–≤–æ–¥–æ–≤",
                "‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤ –Ω–∞ –õ–≠–ü"
            ])
        if weather_code in [71, 73, 75, 85, 86]:
            infrastructure_impact.extend([
                f"‚Ä¢ –ù–∞–ª–∏–ø–∞–Ω–∏–µ —Å–Ω–µ–≥–∞ –Ω–∞ –ø—Ä–æ–≤–æ–¥–∞ ({precipitation} –º–º)",
                "‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ–ø–æ—Ä—ã",
                "‚Ä¢ –£—Ö—É–¥—à–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö —Ä–∞–±–æ—Ç"
            ])
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—Ä–∏–≥–∞–¥–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• —É—Å–ª–æ–≤–∏–π
        recommendations = []
        if critical_risks:
            recommendations.extend([
                "‚Ä¢ –£–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –õ–≠–ü",
                "‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∞–≤–∞—Ä–∏–π–Ω—ã–µ –±—Ä–∏–≥–∞–¥—ã –∫ –≤—ã–µ–∑–¥—É",
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ–ø–æ–≤–µ—â–µ–Ω–∏—è",
                "‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã—Å–æ—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –≤–µ—Ç—Ä–µ"
            ])
        else:
            recommendations.extend([
                "‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è",
                "‚Ä¢ –ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã",
                "‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
            ])
        
        # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö
        technical_measures = []
        if critical_risks:
            technical_measures.extend([
                "‚Ä¢ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞",
                "‚Ä¢ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∑–æ–Ω—ã –∞–≤–∞—Ä–∏–∏",
                "‚Ä¢ –ù–∞—á–∞–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–≥–æ–¥—ã"
            ])
        else:
            technical_measures.extend([
                "‚Ä¢ –ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–º–æ—Ç—Ä—ã",
                "‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞—Ç—è–∂–µ–Ω–∏—è –ø—Ä–æ–≤–æ–¥–æ–≤",
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–ø–ª–µ–Ω–∏–π –æ–ø–æ—Ä"
            ])
        
        result = f"""
üìä –û–¢–ß–ï–¢ –î–õ–Ø: {location.upper()} (–Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö)
üèû –¢–ò–ü –ú–ï–°–¢–ù–û–°–¢–ò: {terrain_data.get('type', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}

üìà –†–ï–ê–õ–¨–ù–´–ï –¢–ï–ö–£–©–ò–ï –ü–û–ì–û–î–ù–´–ï –£–°–õ–û–í–ò–Ø:
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C
‚Ä¢ –í–µ—Ç–µ—Ä: {wind} –º/—Å (–ø–æ—Ä—ã–≤—ã {gusts} –º/—Å)
‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%
‚Ä¢ –û—Å–∞–¥–∫–∏: {precipitation} –º–º
‚Ä¢ –ü–æ–≥–æ–¥–∞: {self._decode_weather_code(weather_code)}

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö):
{chr(10).join(f'- {risk}' for risk in critical_risks) if critical_risks else '- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'}

üìä –í–û–ó–î–ï–ô–°–¢–í–ò–ï –ù–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–£ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö):
{chr(10).join(infrastructure_impact) if infrastructure_impact else '- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'}

üë∑‚Äç‚ôÇÔ∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ë–†–ò–ì–ê–î–ê–ú (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π):
{chr(10).join(recommendations)}

üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è):
{chr(10).join(technical_measures)}

‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–µ–π—Ä–æ—Å–µ—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã.
"""
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ 2000 —Å–∏–º–≤–æ–ª–∞–º–∏
        return result

class PowerRiskBot:
    def __init__(self, token: str):
        self.application = Application.builder().token(token).build()
        self.weather_analyzer = WeatherAnalyzer()
        self.terrain_analyzer = TerrainAnalyzer()
        self.ai_generator = G4FGenerator()
        
        self.setup_handlers()
    
    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥"""
        self.application.add_handler(CommandHandler("start", self.start_command))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("cities", self.cities_command))
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        welcome_text = """
üîå –ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤ –¥–ª—è –õ–≠–ü –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏

ü§ñ –ò—Å–ø–æ–ª—å–∑—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å GPT-4 –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¢–ï–ö–£–©–ò–• –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –¢–ï–ö–£–©–£–Æ –ø–æ–≥–æ–¥—É –≤ —Ü–µ–Ω—Ç—Ä–∞—Ö –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤ –∏ –¥–∞—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è:
‚Ä¢ –õ–∏–Ω–∏–π —ç–ª–µ–∫—Ç—Ä–æ–ø–µ—Ä–µ–¥–∞—á
‚Ä¢ –û–ø–æ—Ä –õ–≠–ü  
‚Ä¢ –†–µ–º–æ–Ω—Ç–Ω—ã—Ö –±—Ä–∏–≥–∞–¥

üìã –ö–æ–º–∞–Ω–¥—ã:
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/help - –ø–æ–º–æ—â—å
/cities - —Å–ø–∏—Å–æ–∫ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤

üìç –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –ø–æ—Å–µ–ª–∫–∞ –∏–ª–∏ —Å–µ–ª–∞
"""
        await update.message.reply_text(welcome_text)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        help_text = """
‚ÑπÔ∏è –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞ –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
   –ù–∞–ø—Ä–∏–º–µ—Ä: "–í–æ–ª–æ–≥–¥–∞", "–í–µ–ª–∏–∫–∏–π –£—Å—Ç—é–≥", "–õ–∏–ø–∏–Ω –ë–æ—Ä", "–®–µ–∫—Å–Ω–∞"

2. –ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç:
   ‚Ä¢ –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ (OpenMeteo)
   ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ (OpenStreetMap)

3. –ù–µ–π—Ä–æ—Å–µ—Ç—å GPT-4 —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:
   ‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤ –¥–ª—è –õ–≠–ü –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏–π
   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—Ä–∏–≥–∞–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
   ‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å —É—á–µ—Ç–æ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã
"""
        await update.message.reply_text(help_text)
    
    async def cities_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /cities"""
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
        cities_by_type = {
            "–ì–æ—Ä–æ–¥–∞": [],
            "–ü–æ—Å–µ–ª–∫–∏": [],
            "–°–µ–ª–∞": []
        }
        
        for name, data in VOLOGDA_REGION_LOCATIONS.items():
            if len(name) > 3 and not name.startswith(('–∏–º ', '–≤–µ–ª–∏–∫–∏–π—É—Å—Ç—é–≥', '–∫–∏—á–º–µ–Ω–≥—Å–∫–∏–π', '—Ç–∞—Ä–Ω–æ–≥—Å–∫–∏–π', '–±–∞–±—É—à–∫–∏–Ω–∞')):
                if data['type'] == '–≥–æ—Ä–æ–¥':
                    cities_by_type["–ì–æ—Ä–æ–¥–∞"].append(name.title())
                elif data['type'] == '–ø–æ—Å–µ–ª–æ–∫':
                    cities_by_type["–ü–æ—Å–µ–ª–∫–∏"].append(name.title())
                elif data['type'] == '—Å–µ–ª–æ':
                    cities_by_type["–°–µ–ª–∞"].append(name.title())
        
        cities_text = "üèô –¶–µ–Ω—Ç—Ä—ã –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤ –í–æ–ª–æ–≥–æ–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏:\n\n"
        
        for loc_type, locations in cities_by_type.items():
            if locations:
                cities_text += f"üìç {loc_type}:\n"
                cities_text += "\n".join(f"‚Ä¢ {loc}" for loc in sorted(locations)) + "\n\n"
        
        await update.message.reply_text(cities_text)
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        user_input = update.message.text.strip().lower()
        
        if user_input in VOLOGDA_REGION_LOCATIONS:
            await self.analyze_location(update, user_input)
        else:
            similar = self.find_similar_locations(user_input)
            if similar:
                text = f"‚ùì –ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç '{user_input}' –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É:\n" + "\n".join(f"‚Ä¢ {c}" for c in similar)
            else:
                text = f"‚ùì –ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç '{user_input}' –Ω–µ –Ω–∞–π–¥–µ–Ω.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cities –¥–ª—è —Å–ø–∏—Å–∫–∞."
            await update.message.reply_text(text)
    
    def find_similar_locations(self, user_input: str) -> List[str]:
        """–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤"""
        similar = []
        for location in VOLOGDA_REGION_LOCATIONS.keys():
            if (user_input in location or 
                any(word in location for word in user_input.split()) or
                any(location.startswith(part) for part in user_input.split())):
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
                display_name = location.title()
                if location in ["–∏–º–µ–Ω–∏ –±–∞–±—É—à–∫–∏–Ω–∞", "–∏–º –±–∞–±—É—à–∫–∏–Ω–∞"]:
                    display_name = "–∏–º. –ë–∞–±—É—à–∫–∏–Ω–∞"
                elif location == "–∫–∏—á–º–µ–Ω–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫":
                    display_name = "–ö–∏—á–º–µ–Ω–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"
                elif location == "—Ç–∞—Ä–Ω–æ–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫":
                    display_name = "–¢–∞—Ä–Ω–æ–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"
                similar.append(display_name)
        return list(set(similar))[:5]
    
    async def analyze_location(self, update: Update, location_name: str):
        """–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è"""
        location_data = VOLOGDA_REGION_LOCATIONS[location_name]
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
        display_name = location_name.title()
        if location_name in ["–∏–º–µ–Ω–∏ –±–∞–±—É—à–∫–∏–Ω–∞", "–∏–º –±–∞–±—É—à–∫–∏–Ω–∞"]:
            display_name = "–∏–º. –ë–∞–±—É—à–∫–∏–Ω–∞"
        elif location_name == "–∫–∏—á–º–µ–Ω–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫":
            display_name = "–ö–∏—á–º–µ–Ω–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"
        elif location_name == "—Ç–∞—Ä–Ω–æ–≥—Å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫":
            display_name = "–¢–∞—Ä–Ω–æ–≥—Å–∫–∏–π –ì–æ—Ä–æ–¥–æ–∫"
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∞–Ω–∞–ª–∏–∑–∞
        analysis_msg = await update.message.reply_text(
            f"üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é {display_name}...\n"
            f"üì° –ü–æ–ª—É—á–∞—é —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ..."
        )
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ
            weather_data = await self.weather_analyzer.get_weather_data(
                location_data['lat'], location_data['lon']
            )
            
            if not weather_data:
                await analysis_msg.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                return
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ—Å—Ç–Ω–æ—Å—Ç—å
            terrain_data = await self.terrain_analyzer.analyze_terrain(
                location_data['lat'], location_data['lon'], display_name, location_data['type']
            )
            
            await analysis_msg.edit_text(
                f"üìç {display_name} - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã\n"
                f"üèû –ú–µ—Å—Ç–Ω–æ—Å—Ç—å: {terrain_data['type']}\n"
                f"ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é..."
            )
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ g4f
            recommendations = await self.ai_generator.generate_recommendations(
                weather_data, terrain_data, display_name
            )
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result_text = f"üìä –û–¢–ß–ï–¢ –î–õ–Ø: {display_name.upper()}\n(–Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π)\n\n{recommendations}"
            
            await update.message.reply_text(result_text)
            await analysis_msg.delete()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}")
            await analysis_msg.edit_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if BOT_TOKEN.startswith('789789789') or len(BOT_TOKEN) < 10:
        print("‚ùå –ó–ê–ú–ï–ù–ò–¢–ï BOT_TOKEN –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –¢–û–ö–ï–ù –û–¢ @BotFather!")
        return
    
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot = PowerRiskBot(BOT_TOKEN)
    
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    print("üìç –î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤:", len(VOLOGDA_REGION_LOCATIONS))
    print("üèô –ì–æ—Ä–æ–¥–∞: 13")
    print("üèò –ü–æ—Å–µ–ª–∫–∏: 4") 
    print("üè° –°–µ–ª–∞: 9")
    print("ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å: GPT-4")
    print("üå§Ô∏è –ê–Ω–∞–ª–∏–∑: —Ç–æ–ª—å–∫–æ –¢–ï–ö–£–©–ò–ï –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è")
    print("üìù –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤: 2000 —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot.application.run_polling()

if __name__ == '__main__':
    main()
